# METHODS — 상태공간 모멘텀(축구) : 방법 재현 문서

본 문서는 **코드 비공개** 원칙을 유지하면서도, 제3자가 모델·절차를 독립적으로 재현 가능한 수준으로 방법을 공개합니다.

## 1) 문제정의
축구 경기에서 이벤트(패스·슛·수비행동 등)가 **잠재적 기세(모멘텀)** 를 만든다는 가설 하에,
시간에 따라 진화하는 잠재상태를 **상태공간모형(SSM)** 으로 모델링하고,
결과지표(향후 5분 xT/볼점유율/ xG)에 대한 예측력과 계수의 해석 가능성을 평가합니다.

## 2) 데이터
- **출처**: StatsBomb Open Data — 이벤트 + 360 위치
- **범위**: 총 292경기
- **단위**: 이벤트 프레임(시퀀스/팀 맥락 포함)
- **결과지표(y)**: `xT_*_next5`, `hold_*_next5_share`, `xG_*_next5`
- **설명변수(X)**: `DATA_DICTIONARY.md` 표의 공격/수비 파생지표

## 3) 전처리 요약
1. **Refine**: 원시 이벤트 정제(중복·좌표·시간 정합) — `1_Event_Refine.ipynb`
2. **Sequence/Line**: 시퀀스 분절, 라인/간격 파생 — `3_Sequence_Line.ipynb`, `4_360_Line.ipynb`
3. **Metrics**: 공격/수비 지표 생성 — `5_Attack_metric.ipynb`, `6_Defense_metric.ipynb`
4. **Join**: 분석 단위 프레임 구성 및 저장(pkl/경기별) — `7_Analysis.ipynb` (덩어리 1)

## 4) 베이스라인 OLS
- 각 (관점=공격/수비)×(결과=xT/hold/xG) 패널에 대해 **OLS** 적합
- out-of-sample(OOS) 평가는 동일한 홀드아웃 분할 사용
- 결과 요약: `ols_screening_all.csv`

## 5) 상태공간모형(SSM)
- **모형**: `UnobservedComponents(level='llevel', exog=X)` — **로컬 레벨(랜덤워크) + 외생 설명변수**
- **학습/검증 분할**: `match_id % 5 == 0` → **검증 20%**, 나머지 80% 학습  
  (키=5 → 나머지 0, 결정론적 분할 · 시드 불필요)
- **A‑1(역할 게이팅)**: 관측 업데이트를 **역할 시점에만** 수행  
  - 공격 패널: **소유팀 구간**에서만 y를 관측(그 외 `NaN`) → 칼만 필터가 **전이만 수행**
  - 수비 패널: **비소유팀 구간**에서만 y를 관측(그 외 `NaN`) → 칼만 필터가 **전이만 수행**
  - 구현상 핵심은 **y 마스킹(관측=NaN)** 으로, 분할/스티칭 없이 **안정적으로 동일 효과** 구현
- **경기별 적합 → 풀링**: 경기별 계수·분산 추정 후
  - **윈저라이징 1%** + **분산 하한(1% 분위수)** 적용
  - **역분산 가중 평균**으로 풀링 계수·표준오차 산출
- **OOS 예측**: 학습 y의 평균(μ_train) 보정 후 **ŷ = μ_train + Xβ**
- **지표**: SNR=Var(ŷ)/Var(y−ŷ), OOS RMSE/MAE, z·p

- 결과 요약: `ssm_pooled_all.csv` (+ 콘솔 스냅샷)

## 6) 검정 및 해석
- **Diebold–Mariano(DM) 테스트**: MSE/MAE 차이에 대한 검정. 본 연구의 시계열격자/대용량/창겹침 특성상
  통계량이 **매우 크게** 나올 수 있으며, 실무 해석은 **OOS RMSE/MAE를 중심**으로 합니다.
- **부호/정합성**: 다수 계수에서 축구 도메인 지식과 정합적 부호/크기가 관찰됨.

### 코드 공개 및 검증 범위

본 연구는 **특징 엔지니어링 노트북 3종**(`1_Event_Refine.ipynb`, `3_Sequence_Line.ipynb`,
`5_Attack_metric.ipynb`)과 결과 검증에 필요한 **모든 파생 산출물(CSV)** 을 공개합니다.
상태공간 학습/평가 노트북(`7_Analysis.ipynb`)과 수비 측 템플릿은 서비스 IP 보호를 위해 비공개로 유지합니다.
이로써 전체 파이프라인 공개 없이도 연구 결과를 **감사(검증)** 할 수 있습니다.

**비공개 코드 없이 가능한 검증 절차**
1) **홀드아웃·표본 수** — 요약 파일에서 분할키와 샘플 크기를 확인합니다.  
2) **OOS 지표** — `oos_predictions_residuals.csv`로 패널별 RMSE/MAE를 재계산하여
   `final_evaluation_summary.csv`와 대조합니다.  
3) **풀링 추론** — `ssm_pooled_all.csv`로 계수/표준오차/z/p를 재현합니다
   (분산 가중 풀링, 분산 하한 및 윈저라이즈는 본문 기술 참조).  
4) **신호 스냅샷** — `ssm_snapshot_flat.csv`의 |z| 분위수, SNR을 확인합니다.  
5) **특징 컬럼 크로스체크** — `attack_features.csv`, `defense_features.csv`의 컬럼을 확인합니다.

위 절차로 논문에 보고된 **핵심 수치**는 모두 재현 가능합니다.


## 7) 재현(코드 비공개 기준)
- **입력**: 공개 CSV(최종 요약 3종, 지표 테이블, 분할 정보)
- **검증자 절차(예)**  
  1) `split_info.json` 규칙으로 train/test 나눔  
  2) 공개된 지표·계수표(`ssm_pooled_all.csv`)로 **μ 보정 선형예측**을 재현  
  3) OOS RMSE/MAE 및 간단한 선형 회귀/상관으로 결과 확인  
  4) DM 테스트는 보조적 참고(격자 특성상 과대 가능)

## 8) 한계/주의
- 공격/수비 **연결 상태**(공-수 상호작용)를 완전 결합한 다차원 상태 설계는 **후속 연구 과제**로 남김
- z-스코어 과대는 **스케일/분산 식별**과도 연결되므로 지속 개선 필요


### LLM 사용 고지
본 프로젝트는 문서 초안 정리, 코드 리팩터링 아이디어, 체크리스트 생성 등에서 LLM의 도움을 받았습니다. 
모든 모델링 의사결정, 데이터 정제와 검증은 저자(단독)가 수행했으며, LLM은 개인 데이터에 접근하거나 분석을 실행하지 않았습니다. 
모든 스크립트와 결과물은 로컬 환경에서 재현·검증되었습니다.
